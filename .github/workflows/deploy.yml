name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  deploy:
    name: Deploy to Ubuntu Server
    runs-on: ubuntu-latest
    
    steps:
      - name: üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è
        run: |
          echo "üöÄ –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –¥–µ–ø–ª–æ–π –Ω–∞ production —Å–µ—Ä–≤–µ—Ä..."
          echo "üì¶ –í–µ—Ç–∫–∞: ${{ github.ref }}"
          echo "üë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}"
          echo "üí¨ –ö–æ–º–º–∏—Ç: ${{ github.event.head_commit.message }}"
      
      - name: üì• Checkout code
        uses: actions/checkout@v3
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: üîê Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            echo "=== üöÄ DragonLost Auto-Deploy ==="
            echo ""
            
            # –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            echo "üìÇ –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞..."
            cd ${{ secrets.PROJECT_PATH }}
            pwd
            echo ""
            
            # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
            echo "üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ Git..."
            git pull origin main
            echo ""
            
            # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
            echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
            npm run install:all
            echo ""
            
            # –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
            echo "üî® –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
            npm run build
            echo ""
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2..."
            pm2 restart ecosystem.config.js --env production
            pm2 save
            echo ""
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
            echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π..."
            pm2 status
            echo ""
            
            echo "=== ‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ! ==="
      
      - name: ‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω
        if: success()
        run: |
          echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
          echo "üåê –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–π—Ç: https://dragonlost.ru"
      
      - name: ‚ùå –î–µ–ø–ª–æ–π –ø—Ä–æ–≤–∞–ª–µ–Ω
        if: failure()
        run: |
          echo "‚ùå –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π!"
          echo "üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π"
          exit 1
      
      - name: üìä –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        if: always()
        run: |
          echo "üìä –°—Ç–∞—Ç—É—Å –¥–µ–ø–ª–æ—è: ${{ job.status }}"
          echo "‚è∞ –í—Ä–µ–º—è: $(date)"
